{% extends 'app/base.html' %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}

<style>

/* Remove all default body/container padding */

body, .product-detail-container {
    margin-left:0%;
    padding: 0;
}


/* ===== LEFT SIDE THUMBNAILS + MAIN IMAGE =====*/

.image-section {

    display: flex;
    align-items: flex-start;
    gap: 20px;
    margin-left: 0;     /* Force to left */
}

/* Remove unwanted spacing from thumbnails list */

.thumbnails {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin: 0;
    padding: 0;
}

.thumbnail {

    width: 100px;
    height: 105px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: 0.3s;
}

.thumbnail:hover, .thumbnail.active {
    border: 4px solid #000;  /* Light Green */
}

.main-image-container {
    position: relative;
}


.main-image {
    width: 500px;
    height: 550px;
    object-fit: cover;
    border-radius: 2px;
}
.main-image:hover{
        border: 2px solid #000;
}
/* ===== RIGHT SIDE DETAILS =====*/

.details-section {
    margin-left: 0;    /* No gap */
}

.product-title {
    font-size: 1.8rem;
    margin-bottom: 10px;
}

.color-info {
    margin-bottom: 10px;
    font-size: 1rem;
}

.price {
    font-size: 1.7rem;
    font-weight: bold;
    margin: 20px 0;
}

.size-options {
    margin: 15px 0;
}

.size-btn {
    padding: 8px 16px;
    margin-right: 10px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
}
.size-btn.selected {
    background-color: #000;  /* Blue background for selected */
    color: #fff;                 /* White text */
    border-color: #fff;       /* Match border to background */
}

.size-btn:hover {
    border-color: #000;
}


.actions {
    margin-top: 20px;
}


#add-to-cart-btn{
    padding: 12px 24px;
    border: none;
    margin-right: 10px;
    cursor: pointer;
    font-size: 1rem;
}
#add-to-cart-btn1 {
    padding: 12px 24px;
    border: none;
    margin-right: 10px;
    cursor: pointer;
    font-size: 1rem;
}

#add-to-cart-btn{
    background: #333;
    color: white;
}

#add-to-cart-btn1 {
    background: white;
    border: 2px solid #333;
}

.accordion-group {
    margin-top: 30px;
    border-top: 1px solid #ddd;
    font-family: 'Segoe UI', sans-serif;
}

.accordion-item {
    border-bottom: 1px solid #ddd;
}

.accordion-header {
    background: none;
    border: none;
    outline: none;
    font-size: 1rem;
    font-weight: 500;
    padding: 16px 0;
    width: 100%;
    text-align: left;
    position: relative;
    cursor: pointer;
    transition: color 0.2s ease;
}

.accordion-header::after {
    content: '+';
    position: absolute;
    right: 0;
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.accordion-header.active::after {
    content: '-';
}

.accordion-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    font-size: 0.95rem;
    color: #444;
    padding-right: 20px;
}


    /* ðŸ”³ Size Chart Modal */

.size-chart-link {

    margin-left: 30px;
    color: steelblue;
    cursor: pointer;
    text-decoration: underline;
}

.size-chart-modal {

    display: none;
    position: fixed;
    top: 0;
    left: 45%;
    width: 50%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.size-chart-content {
    background: white;
    padding: 25px;
    width: 500px;
    border-radius: 6px;
    text-align: center;
}

.size-chart-content table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.size-chart-content th, .size-chart-content td {
    border: 1px solid #ddd;
    padding: 8px;
}

.close-btn {
    float: right;
    font-size: 20px;
    cursor: pointer;
}


   ## zoom in zoom out

    .main-image-container {

    position: relative;
    overflow: hidden; /* hide overflow when zoomed */
}

.main-image {
    transition: transform 0.3s ease;
    cursor: zoom-in; /* hint for zoom */
}

/* Zoomed state */
.main-image.zoomed {
    cursor: zoom-out;
}

### wish list icon


.main-image-container {
    position: relative;
    display: inline-block;
}
.wishlist-btn {
    position: absolute;
    top: 10px;
    right: 14px;
    background: transparent;
    border: none;
    border-radius: 50%;
    padding: 8px;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.3s ease;
    z-index: 10;
}

.heart-icon {
    width: 24px;
    height: 24px;
    fill: none;
    stroke: white;
}

.wishlist-btn.added .heart-icon path {
    fill: #ff6b6b;
    stroke: white;
}





    /* ðŸ“± MOBILE RESPONSIVE STYLES */
@media screen and (max-width: 768px) {

    .product-detail-container {
        flex-direction: column;
        margin: 0;
        padding: 10px;
    }

    /* Thumbnails + Image Side-by-Side */
    .image-section {
        flex-direction: row;
        justify-content: center;
        gap: 5px;
        width: 100%;
    }

    .thumbnails {

        flex-direction: column;
        gap: 5px;
        width: 50px;
        max-height: 300px;
        overflow-y: auto;
    }

    .thumbnail {
        width: 50px;
        height: 55px;
    }

    /* Main Image Container */
    .main-image-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .main-image {
        width: 250px;
        height: 300px;
        object-fit: cover;
    }

    /* Wishlist Icon Fixed on Image */
    .wishlist-btn {
        top: 12px;
        right: 60px;
        padding: 6px;
    }

    .heart-icon {
        width: 20px;
        height: 20px;
    }

    /* Product Details Under Image */
    .details-section {
        margin-top: 20px;
        padding: 0 10px;
        width: 100%;
    }

    .product-title { font-size: 1.4rem; }
    .price { font-size: 1.3rem; }

    .size-btn {
        padding: 6px 12px;
        margin-bottom: 6px;
        font-size: 0.9rem;
    }

    .add-to-cart, .buy-now {
        padding: 10px 18px;
        font-size: 0.9rem;
    }

    .accordion-header {
        font-size: 0.95rem;
        padding: 10px 0;
    }

    /* Center Size Chart Modal */

    .size-chart-modal {
        left: 0;
        width: 100%;
        align-items: center;
        justify-content: center;
    }

    .size-chart-content {
        width: 90%;
        max-width: 300px;
    }
}



</style>


<!-- ========== MAIN CONTAINER ========== -->
<div class="product-detail-container">

   <div class="image-section">
    <div class="thumbnails">
        {% for img in product.images.all %}
        <img src="{{ img.image.url }}" class="thumbnail" onclick="changeImage(this)">
        {% endfor %}
    </div>


   <div class="main-image-container">
    <img id="mainImage" src="{{ product.image.url }}" class="main-image">
    <button type="button" class="wishlist-btn" data-id="{{ product.id }}" onclick="toggleWishlist(event, this)">
      <svg class="heart-icon" viewBox="0 0 24 24">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
                 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
                 C13.09 3.81 14.76 3 16.5 3
                 19.58 3 22 5.42 22 8.5
                 c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
</div>
</div>

    <!-- âœ… DETAILS SECTION -->
    <div class="details-section">
        <h1 class="product-title">{{ product.name }}</h1>
        <hr>
        {% if product.color %}
        <p class="color-info"><strong>Color:</strong> {{ product.color }}</p>
        {% endif %}
        <div class="price">â‚¹ {{ product.price }}</div>
        <hr>

    <!-- âœ… SIZE OPTIONS -->
<div class="size-options">
    <strong>Choose Size:</strong>
    <a href="javascript:void(0)" class="size-chart-link" onclick="openSizeChart()">Size Chart</a><br><br>
    {% for stock in product.stocks.all %}
    <button class="size-btn" data-size="{{ stock.size.id }}">{{ stock.size.code }}</button>
    {% endfor %}
</div>
        <div id="size-warning-msg" style="display:none; color:red; margin-top:10px;"></div>

        <button id="add-to-cart-btn" data-product="{{ product.id }}">Add to Cart</button>
        <button id="add-to-cart-btn1" data-product="{{ product.id }}">BUY NOW</button>


<!-- Success Message -->
<div id="cart-success-msg" style="display:none; color:green; margin-top:10px;"></div>

        <hr>


    <div class="accordion-item">
        <button class="accordion-header">Size & Fit</button>
        <div class="accordion-body">
            <p>Model is 6'1" and wears a size M. Regular fit. Refer to the size chart for guidance.</p>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header">Composition & Care</button>
        <div class="accordion-body">
            <p>100% Linen. Machine wash cold with like colors. Do not bleach. Tumble dry low or line dry.</p>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header">Delivery & Returns</button>
        <div class="accordion-body">
            <p>Delivery in 3-5 business days. Easy 10-day return policy available on all items.</p>
        </div>
    </div>

</div>

</div>
<!-- ðŸ”² Size Chart Modal -->
<div id="sizeChartModal" class="size-chart-modal">
    <div class="size-chart-content">
        <span class="close-btn" onclick="closeSizeChart()">&times;</span>
        <h2>Size Chart</h2>
        <table>
            <tr>
                <th>Size</th>
                <th>Chest (in)</th>
                <th>Length (in)</th>
                <th>Shoulder (in)</th>
            </tr>
            <tr><td>S</td><td>38</td><td>26</td><td>16.5</td></tr>
            <tr><td>M</td><td>40</td><td>27</td><td>17</td></tr>
            <tr><td>L</td><td>42</td><td>28</td><td>17.5</td></tr>
            <tr><td>XL</td><td>44</td><td>29</td><td>18</td></tr>
            <tr><td>XXL</td><td>46</td><td>30</td><td>18.5</td></tr>
        </table>
    </div>
</div>


<!-- âœ… JS IMAGE SWITCH -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
function changeImage(img) {
    document.getElementById("mainImage").src = img.src;

    // Remove active class
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    img.classList.add('active');
}
    function openSizeChart() {
    document.getElementById("sizeChartModal").style.display = "flex";
}
function closeSizeChart() {
    document.getElementById("sizeChartModal").style.display = "none";
}


    document.addEventListener("DOMContentLoaded", function () {
    const headers = document.querySelectorAll(".accordion-header");

    headers.forEach(header => {
        header.addEventListener("click", function () {
            const body = this.nextElementSibling;
            const isOpen = this.classList.contains("active");

            // Close all open sections
            document.querySelectorAll(".accordion-body").forEach(b => b.style.maxHeight = null);
            document.querySelectorAll(".accordion-header").forEach(h => h.classList.remove("active"));

            // If it wasn't already open, open it
            if (!isOpen) {
                this.classList.add("active");
                body.style.maxHeight = body.scrollHeight + "px";
            }
        });
    });
});

  // Existing thumbnail switch function
function changeImage(img) {
    const mainImage = document.getElementById("mainImage");
    mainImage.src = img.src;

    // Remove active class
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    img.classList.add('active');

    // Remove zoom when image changes
    mainImage.classList.remove('zoomed');
    mainImage.style.transform = 'scale(1)';
}

// Zoom in / out
const mainImage = document.getElementById('mainImage');

mainImage.addEventListener('click', function () {
    if (this.classList.contains('zoomed')) {
        // Zoom out
        this.style.transform = 'scale(1)';
        this.classList.remove('zoomed');
    } else {
        // Zoom in
        this.style.transform = 'scale(2)'; // 2x zoom
        this.classList.add('zoomed');
    }
});

// Optional: pan effect on desktop
mainImage.addEventListener('mousemove', function(e) {
    if (!this.classList.contains('zoomed')) return;

    const rect = this.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    this.style.transformOrigin = `${x}% ${y}%`;
});



// ====== CSRF HELPER ======
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ====== TOGGLE WISHLIST ======
function toggleWishlist(event, btn) {
    event.preventDefault();
    const productId = btn.dataset.id;

    fetch(`/wishlist/toggle/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.added !== undefined) {
            btn.classList.toggle('added', data.added);
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(err => console.error(err));
}

// ====== INITIALIZE WISHLIST ON PAGE LOAD ======
document.addEventListener("DOMContentLoaded", () => {
    const wishlistProducts = JSON.parse('{{ wishlist_ids|safe }}');
    wishlistProducts.forEach(id => {
        const btn = document.querySelector(`.wishlist-btn[data-id="${id}"]`);
        if (btn) btn.classList.add('added');
    });
});



// Select size button
let selectedSizeId = null;
$('.size-btn').click(function() {
    $('.size-btn').removeClass('selected'); // Remove previous selection
    $(this).addClass('selected');
    selectedSizeId = $(this).data('size');
});

// Add to cart AJAX

$('#add-to-cart-btn').click(function() {
      if (!selectedSizeId) {
        $('#size-warning-msg').text('Please select a size!').fadeIn().delay(2000).fadeOut();
        return;
    }

    let product_id = $(this).data('product');

    $.ajax({
        url: "{% url 'add_to_cart' %}",
        method: "POST",
        data: {
            'product_id': product_id,
            'size_id': selectedSizeId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response){
            if(response.success){
                $('#cart-success-msg').text(response.message).fadeIn().delay(2000).fadeOut();
            } else {
                alert('Failed to add to cart!Please LogIn And Continue');
            }
        }
    });
});


// BUY NOW - Add to cart and redirect to cart

$('#add-to-cart-btn1').click(function() {
    if (!selectedSizeId) {
        $('#size-warning-msg')
            .text('Please select a size!')
            .fadeIn()
            .delay(2000)
            .fadeOut();
        return;
    }

    let product_id = $(this).data('product');

    $.ajax({
        url: "{% url 'add_to_cart' %}",
        method: "POST",
        data: {
            'product_id': product_id,
            'size_id': selectedSizeId,
            'quantity': 1,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // Optional: show a quick message
                $('#cart-success-msg')
                    .text(response.message + " Redirecting to cart...")
                    .fadeIn()
                    .delay(800)
                    .fadeOut();

                // âœ… Redirect to cart page
                setTimeout(function() {
                    window.location.href = "{% url 'cart' %}";
                }, 800);
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert('Something went wrong. Please try again.');
        }
    });
});




</script>

{% endblock %}
