{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% if address %}Edit Address{% else %}Add Address{% endif %}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
.container { max-width:600px; margin:auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
h2 { text-align:center; margin-bottom:20px; color:#000; }
label { display:block; margin:12px 0 5px; font-weight:600; }
.required { color:red; }
input, select { width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
button, .location-btn { width:100%; padding:12px; border:none; border-radius:6px; background:#000; color:#fff; font-size:1rem; cursor:pointer; margin-bottom:10px; }
button:hover, .location-btn:hover { background:#333; }
.phone-input { display:flex; gap:5px; }
.phone-input select { width:30%; }
.phone-input input { width:70%; }
#location-status, #pin-status { font-size:0.9rem; color:#444; margin-bottom:10px; }
.back-link { display:block; margin-top:15px; text-align:center; }
@media(max-width:500px){ .container { padding:15px; } .phone-input select{ width:35%; } .phone-input input{ width:65%; } }
</style>
</head>
<body>

<div class="container">
<h2>{% if address %}Edit Address{% else %}Add Address{% endif %}</h2>

{% if messages %}
  {% for message in messages %}
    <p style="color:green">{{ message }}</p>
  {% endfor %}
{% endif %}

<form method="POST">
{% csrf_token %}

<label for="fullname">Full Name <span class="required">*</span></label>
<input type="text" id="fullname" name="fullname" placeholder="Enter Full Name" value="{{ address.fullname|default:'' }}" required>

<label for="mobile">Mobile Number <span class="required">*</span></label>
<div class="phone-input">
  <select id="country-code" name="country_code" required>
    <option value="+91" selected>ğŸ‡®ğŸ‡³ +91</option>
    <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
    <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
    <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
    <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
     <option value="+1">ğŸ‡ºğŸ‡¸ USA +1</option>
  <option value="+44">ğŸ‡¬ğŸ‡§ UK +44</option>
   <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
  <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
  <option value="+33">ğŸ‡«ğŸ‡· +33</option>
  <option value="+39">ğŸ‡®ğŸ‡¹ +39</option>
  <option value="+7">ğŸ‡·ğŸ‡º +7</option>
  <option value="+971">ğŸ‡¦ğŸ‡ª +971</option>
  <option value="+27">ğŸ‡¿ğŸ‡¦ +27</option>
  <option value="+55">ğŸ‡§ğŸ‡· +55</option>
  <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
  <option value="+34">ğŸ‡ªğŸ‡¸ +34</option>
  <option value="+64">ğŸ‡³ğŸ‡¿ +64</option>
  <option value="+60">ğŸ‡²ğŸ‡¾ +60</option>
  <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
  <option value="+82">ğŸ‡°ğŸ‡· +82</option>
  <option value="+46">ğŸ‡¸ğŸ‡ª +46</option>
  <option value="+358">ğŸ‡«ğŸ‡® +358</option>
  </select>
  <input type="tel" id="mobile" name="mobile" placeholder="Enter Mobile Number" value="{{ address.mobile|default:'' }}" required>
</div>

<label for="address1">Address Line 1 <span class="required">*</span></label>
<input type="text" id="address1" name="address1" placeholder="House No, Street, Area" value="{{ address.address1|default:'' }}" required>

<label for="address2">Address Line 2 <span class="required">*</span></label>
<input type="text" id="address2" name="address2" placeholder="Colony, Locality, Landmark" value="{{ address.address2|default:'' }}" required>

<label for="landmark">Landmark</label>
<input type="text" id="landmark" name="landmark" placeholder="Nearby landmark" value="{{ address.landmark|default:'' }}">

<label for="pincode">PIN Code <span class="required">*</span></label>
<input type="text" id="pincode" name="pincode" placeholder="Enter PIN Code" value="{{ address.pincode|default:'' }}" maxlength="6" required>
<p id="pin-status"></p>

<label for="city">City <span class="required">*</span></label>
<input type="text" id="city" name="city" placeholder="Auto-filled or enter manually" value="{{ address.city|default:'' }}" required>

<label for="state">State <span class="required">*</span></label>
<input type="text" id="state" name="state" placeholder="Auto-filled or enter manually" value="{{ address.state|default:'' }}" required>

<label for="country">Country <span class="required">*</span></label>
<select id="country" name="country" required>
  <option value="">Select Country</option>
  <option value="India" selected>India </option>
  <option value="United States">United States </option>
  <option value="United Kingdom">United Kingdom </option>
  <option value="Australia">Australia </option>
  <option value="United Arab Emirates">United Arab Emirates ğŸ‡¦ğŸ‡ª</option>
  
  
</select>

<button type="button" class="location-btn" onclick="getLocation()"><i class="fa-solid fa-location-dot"></i> Use My Current Location</button>
<p id="location-status"></p>

<button type="submit">{% if address %}Update Address{% else %}Save Address{% endif %}</button>
</form>

<a href="{% url 'base:address_list' %}" class="back-link">Back to Address List</a>
</div>

<script>
// ğŸ”¹ Auto-fill City/State from Indian Pincode
const pinInput = document.getElementById("pincode");
pinInput.addEventListener("input", async () => {
  const pin = pinInput.value.trim();
  if(pin.length === 6 && /^[0-9]+$/.test(pin)){
    try{
      const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
      const data = await res.json();
      if(data[0].Status==="Success"){
        document.getElementById("city").value = data[0].PostOffice[0].District;
        document.getElementById("state").value = data[0].PostOffice[0].State;
      }
    } catch(err){ console.log(err); }
  }
});

// ğŸ”¹ Current Location Autofill
async function getLocation(){
  const status = document.getElementById("location-status");
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const {latitude: lat, longitude: lon} = pos.coords;
      status.textContent = "Fetching location...";
      try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const data = await res.json();

        document.getElementById("address1").value = data.address.house_number || data.address.road || "";
        document.getElementById("address2").value = data.address.suburb || data.address.neighbourhood || "";
        
        const cityName = data.address.city || data.address.town || data.address.village || data.address.county || "";
        document.getElementById("city").value = cityName;
        document.getElementById("state").value = data.address.state || "";
        document.getElementById("pincode").value = data.address.postcode || "";

        const country = data.address.country;
        const countrySelect = document.getElementById("country");
        Array.from(countrySelect.options).forEach(option => {
          if(option.value.toLowerCase() === country.toLowerCase()){
            option.selected = true;
          }
        });

        status.textContent = "Location filled!";
      } catch(err){
        status.textContent = "Error fetching location data.";
      }
    });
  } else {
    status.textContent = "Geolocation not supported.";
  }
}
</script>

</body>
</html>
